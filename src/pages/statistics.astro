---
import SiteBaseLayout from "../layouts/SiteBaseLayout.astro";

import ButtonComponent from "../components/ButtonComponent.astro"

// INFO: Import the json data directly from the filesystem in the project repo
import result from "../data/statistics.json"
---


<!-- INFO: The script runs on the client (browser) and is not inside the container! -->
<script>
  const development = false;
  const csrBtn = document.querySelector('#csr-button');
  const tbody = document.querySelector('#table-body');

  async function getData() {
    // INFO: On dev we run the nginx server in a docker container to server static files
    if (development) {
      const url = "http://localhost:8080/data/statistics";
    } else {
      // On prod (github) no docker container -> no ngixn werbserver
      // We duplicated the statistics.json file into the public folder, so Astro serves it as static file
      const url = "https://nick-sohl.github.io/fit-app/data/statistics.json"
    }

    try {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`Response status: ${response.status}`);
      }

      const result = await response.json();

      tbody.innerHTML = ""

      // Set timeout to make client side fetch visisble
      setTimeout( () => {
        result?.countries && Object.entries(result.countries).map(([code, data]) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="px-3 py-4 text-sm text-indigo-400 whitespace-nowrap">${code}</td>
            <td class="px-3 py-4 text-sm text-gray-400 whitespace-nowrap">${data.rank ?? "–"}</td>
            <td class="px-3 py-4 text-sm text-gray-400 whitespace-nowrap">${data.both ?? "–"}</td>
            <td class="px-3 py-4 text-sm text-gray-400 whitespace-nowrap">${data.male ?? "–"}</td>
            <td class="px-3 py-4 text-sm text-gray-400 whitespace-nowrap">${data.female ?? "–"}</td>
          `;
          tbody.appendChild(row);
        });
      }
      , 1000)
    } catch (error) {
      console.error(error.message);
    }
  }

  csrBtn.addEventListener("click", getData);
</script>

<SiteBaseLayout title="Statistics">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 my-16">
    <div class="sm:flex sm:items-center">
      <div class="sm:flex-auto">
        <h1 class="text-base font-semibold text-white">BMI-Statistiken</h1>
        <p class="mt-2 text-sm text-gray-300">
          Durchschnittliche BMI-Werte pro Land (Stand: 01.01.2024)
        </p>
      </div>
      <div>
        <ButtonComponent
          id="csr-button"
          primary="true"
          buttonText="Fetch Data Client Side"
          buttonType="button"
        />
      </div>
    </div>

    <div class="mt-8 flow-root">
      <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
        <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
          <div
            class="overflow-hidden outline-1 -outline-offset-1 outline-white/10 sm:rounded-lg"
          >
            <table class="relative min-w-full divide-y divide-white/15">
              <thead class="bg-gray-800/75">
                <tr>
                  <th
                    scope="col"
                    class="px-3 py-3.5 text-left text-sm font-semibold text-gray-200"
                    >ISO 3166</th
                  >
                  <th
                    scope="col"
                    class="px-3 py-3.5 text-left text-sm font-semibold text-gray-200"
                    >Rang</th
                  >
                  <th
                    scope="col"
                    class="px-3 py-3.5 text-left text-sm font-semibold text-gray-200"
                    >Gesamt</th
                  >
                  <th
                    scope="col"
                    class="px-3 py-3.5 text-left text-sm font-semibold text-gray-200"
                    >Männlich</th
                  >
                  <th
                    scope="col"
                    class="px-3 py-3.5 text-left text-sm font-semibold text-gray-200"
                    >Weiblich</th
                  >
                </tr>
              </thead>


              <tbody id="table-body" class="divide-y divide-white/10 bg-gray-800/50">
                {
                  Object.entries(result.countries).map(([code, data]) => (
                    <tr>
                      <td class="px-3 py-4 text-sm text-gray-400 whitespace-nowrap"
                        >{ code }</td
                      >
                      <td class="px-3 py-4 text-sm text-gray-400 whitespace-nowrap"
                        >{ data.rank ?? "–" }</td
                      >
                      <td class="px-3 py-4 text-sm text-gray-400 whitespace-nowrap"
                          >{ data.both ?? "–" }</td
                      >
                      <td class="px-3 py-4 text-sm text-gray-400 whitespace-nowrap"
                          >{ data.male ?? "-" }</td
                      >
                      <td class="px-3 py-4 text-sm text-gray-400 whitespace-nowrap"
                          >{ data.female ?? "–" }</td
                      >
                    </tr>
                  ))
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</SiteBaseLayout>
